┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                               KENNY AI CHAT SYSTEM ARCHITECTURE                                    │
│                                   With Ollama & Tool Access                                        │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                      🌐 USER INTERFACES                                           │
├─────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                     │
│  ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────────────────────┐    │
│  │   React Frontend    │    │   Direct HTTP API   │    │        Swagger Docs UI              │    │
│  │   (Next.js v0)      │◄──►│    (curl/Postman)   │◄──►│     (/docs endpoint)                │    │
│  │   localhost:3000    │    │                     │    │                                     │    │
│  │                     │    │  - Chat streaming    │    │  Interactive API testing            │    │
│  │  Chat Interface     │    │  - Tool execution    │    │  Schema documentation              │    │
│  │  Real-time SSE      │    │  - Contact search    │    │                                     │    │
│  └─────────────────────┘    └─────────────────────┘    └─────────────────────────────────────┘    │
│           │                           │                                      │                      │
└───────────┼───────────────────────────┼──────────────────────────────────────┼──────────────────────┘
            │                           │                                      │
            ▼                           ▼                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                  🚀 KENNY FASTAPI BACKEND                                        │
│                                    (Port 8080)                                                   │
├─────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                              📡 API ENDPOINTS                                                 │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐ │ │
│  │  │   Chat Stream   │  │   Direct Chat   │  │    Tool Exec    │  │    Contact Management  │ │ │
│  │  │                 │  │                 │  │                 │  │                         │ │ │
│  │  │ GET /api/chat/  │  │ POST /chat      │  │ POST /tools/    │  │ GET /contacts           │ │ │
│  │  │ stream?message  │  │                 │  │ execute         │  │ GET /contacts/{id}      │ │ │
│  │  │ &key=demo-key   │  │ Body:           │  │                 │  │ GET /contacts/{id}/     │ │ │
│  │  │                 │  │ {"message":".."}│  │ Body:           │  │ thread                  │ │ │
│  │  │ SSE Stream      │  │                 │  │ {"name":".."}   │  │ GET /search             │ │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                    │                                               │
│                                                    ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                         🔧 SERVICE LAYER ARCHITECTURE                                        │ │
│  │                                                                                               │ │
│  │  ┌─────────────────────┐              ┌─────────────────────┐              ┌───────────────┐ │ │
│  │  │  OllamaLLMService   │◄────────────►│ OrchestratorService │◄────────────►│ ContactData   │ │ │
│  │  │                     │              │                     │              │ Service       │ │ │
│  │  │ • Model: mistral-   │              │ • Validates args    │              │               │ │ │
│  │  │   small3.1:latest   │              │ • Prevents injection│              │ • Contact     │ │ │
│  │  │ • Temperature: 0.7  │              │ • 30s timeout       │              │   resolution  │ │ │
│  │  │ • 60s timeout       │              │ • SQL fallback      │              │ • Thread      │ │ │
│  │  │ • Function calling  │              │                     │              │   merging     │ │ │
│  │  │ • Tool selection    │              │                     │              │ • Memory      │ │ │
│  │  └─────────────────────┘              └─────────────────────┘              │   lookup      │ │ │
│  │                                                    │                       └───────────────┘ │ │
│  └────────────────────────────────────────────────────┼─────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┼───────────────────────────────────────────┘
                                                          │
                                                          ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    🤖 OLLAMA INTEGRATION                                         │
├─────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                    🧠 LOCAL LLM WITH FUNCTION CALLING                                        │ │
│  │                                                                                               │ │
│  │  ┌─────────────────────┐              ┌─────────────────────┐              ┌───────────────┐ │ │
│  │  │    Mistral Model    │◄────────────►│   Function Tools    │◄────────────►│  Tool Results │ │ │
│  │  │                     │              │                     │              │               │ │ │
│  │  │ • Local execution   │              │ • search_documents  │              │ • JSON output │ │ │
│  │  │ • No cloud deps     │              │ • search_contacts   │              │ • Structured  │ │ │
│  │  │ • Privacy-first     │              │ • get_recent_msgs   │              │   responses   │ │ │
│  │  │ • 4-bit quantized   │              │                     │              │ • Error       │ │ │
│  │  │ • 3.5B parameters   │              │                     │              │   handling    │ │ │
│  │  └─────────────────────┘              └─────────────────────┘              └───────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                    │                                               │
└─────────────────────────────────────────────────────┼───────────────────────────────────────────┘
                                                      │
                                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                            🛠️ SWIFT ORCHESTRATOR_CLI SYSTEM                                     │
├─────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                                📋 AVAILABLE COMMANDS                                         │ │
│  │                                                                                               │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐ │ │
│  │  │     search      │  │ meeting analyze │  │ meeting propose │  │        status           │ │ │
│  │  │                 │  │     -threads    │  │     -slots      │  │                         │ │ │
│  │  │ • Full-text     │  │                 │  │                 │  │ • System health         │ │ │
│  │  │   search        │  │ • Email thread  │  │ • Calendar      │  │ • Database stats        │ │ │
│  │  │ • Multi-source  │  │   analysis      │  │   conflicts     │  │ • Performance metrics  │ │ │
│  │  │ • BM25 ranking  │  │ • Meeting opps  │  │ • Time slots    │  │ • Ingestion status      │ │ │
│  │  │ • SQL fallback  │  │                 │  │                 │  │                         │ │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                    │                                               │
└─────────────────────────────────────────────────────┼───────────────────────────────────────────┘
                                                      │
                                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                💾 DATABASE LAYER                                                 │
├─────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                     │
│  ┌──────────────────────────────────────────┐       ┌──────────────────────────────────────────┐ │
│  │              🗃️ KENNY.DB                │       │           👥 CONTACT_MEMORY.DB            │ │
│  │           (Main Data Store)              │       │          (Contact Resolution)             │ │
│  │                                          │       │                                          │ │
│  │  ┌─────────────────────────────────────┐ │       │  ┌─────────────────────────────────────┐ │ │
│  │  │        📊 DATA COUNTS               │ │       │  │        📊 CONTACT DATA              │ │ │
│  │  │                                     │ │       │  │                                     │ │ │
│  │  │ • 233,895 total documents          │ │◄─────►│  │ • 1,323 unique contacts            │ │ │
│  │  │ • WhatsApp:    177,865             │ │       │  │ • 2,847 identities                 │ │ │
│  │  │ • Mail:         27,144             │ │       │  │ • 1,521 relationships              │ │ │
│  │  │ • Messages:     26,861             │ │       │  │ • 4,203 memories                   │ │ │
│  │  │ • Calendar:        703             │ │       │  │ • 12,401 thread links              │ │ │
│  │  │ • Contacts:      1,321             │ │       │  │                                     │ │ │
│  │  │                                     │ │       │  │                                     │ │ │
│  │  └─────────────────────────────────────┘ │       │  └─────────────────────────────────────┘ │ │
│  │                                          │       │                                          │ │
│  │  ┌─────────────────────────────────────┐ │       │  ┌─────────────────────────────────────┐ │ │
│  │  │          🔍 SEARCH SYSTEM           │ │       │  │       🔗 RELATIONSHIP MAPPING       │ │ │
│  │  │                                     │ │       │  │                                     │ │ │
│  │  │ • FTS5 full-text index             │ │       │  │ • Phone/Email identity linking     │ │ │
│  │  │ • Vector embeddings (partial)      │ │       │  │ • WhatsApp JID resolution          │ │ │
│  │  │ • BM25 ranking algorithm           │ │       │  │ • Cross-platform threading         │ │ │
│  │  │ • Hybrid search capabilities       │ │       │  │ • Fuzzy name matching              │ │ │
│  │  │ • Sub-500ms response time          │ │       │  │ • Confidence scoring               │ │ │
│  │  │                                     │ │       │  │                                     │ │ │
│  │  └─────────────────────────────────────┘ │       │  └─────────────────────────────────────┘ │ │
│  └──────────────────────────────────────────┘       └──────────────────────────────────────────┘ │
│                      │                                                │                          │
└──────────────────────┼────────────────────────────────────────────────┼──────────────────────────┘
                       │                                                │
                       ▼                                                ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              📱 DATA SOURCES & INGESTION                                         │
├─────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐ │
│  │  WhatsApp   │  │    Mail     │  │  Messages   │  │  Calendar   │  │       Contacts          │ │
│  │             │  │             │  │             │  │             │  │                         │ │
│  │ • SQLite    │  │ • AppleScript│  │ • SQLite    │  │ • EventKit  │  │ • CNContactStore        │ │
│  │   direct    │  │   bridge    │  │   direct    │  │   API       │  │   API                   │ │
│  │ • Real-time │  │ • Headers + │  │ • Chat.db   │  │ • Events +  │  │ • Full contact data     │ │
│  │   sync      │  │   content   │  │   access    │  │   metadata  │  │ • Photo paths           │ │
│  │ • 177K msgs │  │ • 27K mails │  │ • 26K msgs  │  │ • 703 evts  │  │ • 1,321 contacts        │ │
│  │ • Bridge    │  │ • Thread    │  │ • SMS/iMsg  │  │ • Meeting   │  │ • Company info          │ │
│  │   protocol  │  │   tracking  │  │   combined  │  │   analysis  │  │ • Role tracking         │ │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────────────┘ │
│                                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                  🔐 SECURITY & PRIVACY                                           │
├─────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                     │
│  • 🔒 API Key Authentication (KENNY_API_KEY)                                                       │
│  • 🛡️  CORS Protection with allowed origins                                                        │
│  • 🚫 Input sanitization against injection attacks                                                 │
│  • 🔒 Local-only data processing (no cloud dependencies)                                           │
│  • 📋 Comprehensive audit logging                                                                  │
│  • ⏱️  Request timeouts and rate limiting                                                          │
│  • 🔐 Secure database connections with prepared statements                                         │
│                                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              ⚡ PERFORMANCE CHARACTERISTICS                                       │
├─────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                     │
│  🔍 Search Performance:                    💬 Chat Performance:                                   │
│  • Document search: 150-300ms             • LLM response: 2-5 seconds                            │
│  • Contact fuzzy match: 100-200ms         • Tool execution: 200-500ms                            │
│  • Recent messages: 200-400ms             • End-to-end query: 3-8 seconds                        │
│                                                                                                     │
│  💾 Database Performance:                  🌐 API Performance:                                    │
│  • FTS5 queries: <10ms for simple         • HTTP response: 50-100ms                              │
│  • Complex joins: 50-200ms                • SSE streaming: Real-time                             │
│  • Insert operations: 1-5ms               • Concurrent users: 10+ supported                      │
│                                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                   🔄 DATA FLOW SUMMARY                                           │
├─────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                     │
│  1. 👤 User sends message via React frontend or HTTP API                                           │
│  2. 🔐 FastAPI validates authentication and sanitizes input                                        │
│  3. 🧠 OllamaLLMService processes query with Mistral model                                         │
│  4. 🤖 Model determines which tools are needed for response                                        │
│  5. 🛠️  OrchestratorService executes Swift orchestrator_cli commands                              │
│  6. 🗃️  Commands query kenny.db and contact_memory.db databases                                   │
│  7. 📊 Results are processed and formatted by service layer                                        │
│  8. 🧠 LLM generates natural language response using retrieved data                               │
│  9. 📡 Response streamed back to frontend via Server-Sent Events                                  │
│  10.💾 Session memory updated for conversation continuity                                          │
│                                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

LAST UPDATED: Week 9 (August 2024) - Production deployment with Ollama integration
FILE SIZE: kenny.db (254MB) | contact_memory.db (45MB) | Total documents: 233,895